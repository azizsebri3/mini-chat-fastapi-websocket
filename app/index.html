<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Chat</title>
    <style>
        #container {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: scroll;
        }
        #inputText {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Chat</h1>

    <!-- Champ pour saisir le nom d'utilisateur -->
    <label for="username">Enter your username:</label>
    <input type="text" id="username" placeholder="Your username">
    <button id="connectButton">Connect</button>

    <!-- Sélectionner un utilisateur pour chatter -->
    <label for="receiver">Select a User to chat with:</label>
    <select id="receiver">
        <!-- La liste des utilisateurs sera ajoutée ici dynamiquement -->
    </select>

    <!-- Champ pour taper le message -->
    <input type="text" id="inputText" placeholder="Type your message...">
    <button id="submitButton" disabled>Send</button>

    <!-- Zone pour afficher les messages -->
    <div id="container"></div>

    <script>
        let socket = null;  // WebSocket connection
        let username = '';  // Le nom d'utilisateur
        let selectedUser = '';  // L'utilisateur sélectionné pour discuter

        // Fonction pour afficher les messages
        function showMessage(message, sender) {
            // Vérifier si le message est destiné à l'utilisateur actuel
            if (sender === selectedUser) {
                const messageContainer = document.getElementById('container');
                const messageElement = document.createElement('div');
                messageElement.textContent = `${sender}: ${message}`;
                messageContainer.appendChild(messageElement);
                messageContainer.scrollTop = messageContainer.scrollHeight;  // Scroll vers le bas pour afficher le dernier message
            }
        }

        // Fonction pour mettre à jour la liste des utilisateurs dans le menu déroulant
        function updateUserList(users) {
            const receiverSelect = document.getElementById('receiver');
            receiverSelect.innerHTML = "";  // Vider la liste actuelle
            
            // Ajouter un utilisateur à la liste déroulante
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                receiverSelect.appendChild(option);
            });
        }

        // Se connecter au serveur WebSocket avec le nom d'utilisateur
        document.getElementById("connectButton").addEventListener("click", function() {
            username = document.getElementById("username").value;
            if (!username) {
                alert("Please enter a username.");
                return;
            }

            // Créer une nouvelle connexion WebSocket
            socket = new WebSocket(`ws://127.0.0.1:8000/ws/${username}`);

            // Quand la connexion est établie
            socket.onopen = function() {
                console.log("Connected to the WebSocket server!");
                document.getElementById("submitButton").disabled = false;
            };

            // Réception des messages du serveur
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === "user_list") {
                    // Mettre à jour la liste des utilisateurs quand elle est envoyée
                    updateUserList(data.users);
                } else {
                    // Afficher le message reçu
                    const messageData = JSON.parse(event.data);
                    showMessage(messageData.message, messageData.sender);
                }
            };

            // Gérer les erreurs WebSocket
            socket.onerror = function(error) {
                console.log("WebSocket error: ", error);
            };
        });

        // Envoi du message
        document.getElementById("submitButton").addEventListener("click", function() {
            const inputText = document.getElementById("inputText");
            selectedUser = document.getElementById("receiver").value;  // Obtenir l'utilisateur sélectionné
            const message = inputText.value;
            
            // Créer l'objet avec le message et l'utilisateur cible
            const messageData = JSON.stringify({
                receiver: selectedUser,
                message: message
            });
            
            // Envoyer au serveur
            socket.send(messageData);
            inputText.value = "";  // Effacer le champ après envoi
        });
    </script>
</body>
</html>
